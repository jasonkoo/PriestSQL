$(function(){function getTimeL(e){var a=Math.floor(e/864e5),t=Math.floor(e/36e5)-24*a,s=Math.floor(e/6e4)-24*a*60-60*t,i=Math.floor(e/1e3)-24*a*60*60-60*t*60-60*s,d=[];return a>0&&d.push(a+"d"),t>0&&d.push(t+"h"),s>0&&d.push(s+"m"),i>0?d.push(i+"s"):d.push("0s"),d.join(":")}function getAppList(){Util.ajax({url:"entry/getApplication",success:function(data){var _html='<div class="keywordSearch"><input type="text" class="form-control" id="UserKeyword" placeholder="Search..."></div><ul class="dropdownMenu">';$.each(data.data,function(e,a){_html+='<li data-user="'+a.appUser+'" data-name="'+a.appName+'"><a href="javascript:;">'+a.appName+"</a></li>",AppList[a.appUser]=a.appName}),_html+="</ul>",$("#UserList").html(_html),store.get(UserName+"user")&&void 0!=AppList[store.get(UserName+"user").split("||")[0]]?$("#UserSel").html(store.get(UserName+"user").split("||")[1]).data("user",store.get(UserName+"user").split("||")[0]):$("#UserSel").html(data.data[0].appName).data("user",data.data[0].appUser),getJobList(),$("#UserKeyword").keyup(function(e){switch(e.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:break;default:$("#UserList").scrollTop(0),$("#UserList li").each(function(){if(!$(this).hasClass("keywordSearch")){var _keyword=$("#UserKeyword").val(),_thisHtml=$(this).attr("data-name");""!=_keyword?RegExp(_keyword,"i").test($(this).attr("data-name"))?(_thisHtml=_thisHtml.replace(eval("/("+_keyword+")/gi"),'<span class="key">$1</span>'),$(this).find("a").html(_thisHtml),$(this).show()):$(this).hide():(_thisHtml=_thisHtml.replace('<span class="key">',""),_thisHtml=_thisHtml.replace("</span>",""),$(this).find("a").html(_thisHtml),$(this).show())}})}})}})}function getJobList(e){var a={proxyUserName:$("#UserSel").data("user"),page:e||1,pageSize:50},t="job/list";""!=$("#FileFilter").val()&&$.extend(a,{paramString:$("#FileFilter").val()}),$("#FileOpts").find(".active").length>0&&$.extend(a,{runningState:$("#FileOpts").find(".active").data("type")}),Util.ajax({url:t,data:a,success:function(e){if($("#FileList").scrollTop(0),e=e.data,0==e.rows.length)return $("#TipNull").removeClass("hidden"),$("#FileList").html(""),void $("#FileListPage").html("");$("#TipNull").addClass("hidden");var a="";$.each(e.rows,function(e,t){var s=t.terminable?'<a href="javascript:;" class="btn btn-primary btn-xs stopJob" data-id="'+t.appId+'">Stop</a>':"",i="";"FINISHED"==t.state?i='<span class="label label-success">'+t.state+"</span>":"RUNNING"==t.state?i='<span class="label label-info">'+t.state+"</span>":"KILLED"==t.state?i='<span class="label label-warning">'+t.state+"</span>":"FAILED"==t.state&&(i='<span class="label label-danger">'+t.state+"</span>");var d="",l="";0!=t.finishiTime&&(d=getTimeL(t.finishiTime-t.submitTime),l=new Date(t.finishiTime).Format("yyyy-MM-dd hh:mm:ss")),a+='<tr><td width="15%">'+t.appId+'</td><td width="18%">'+t.name+'</td><td width="10%">'+t.applicationType+'</td><td width="8%">'+i+'</td><td width="7%">'+(100*t.process).toFixed(2)+'%</td><td width="8%">'+t.queue+'</td><td width="8%">'+d+'</td><td width="8%">'+new Date(t.submitTime).Format("yyyy-MM-dd hh:mm:ss")+'</td><td width="8%">'+l+'</td><td width="10%">'+s+"</td></tr>"}),$("#FileList").html(a),e.total>50?($("#FileListPage").html('<div class="inner"></div><div class="pageInfo" id="PageInfo"></div>'),$("#FileListPage .inner").bootpag({total:Math.ceil(e.total/50),page:e.pageIndex,maxVisible:5}).on("page",function(e,a){getJobList(a)}),$("#PageInfo").html($.i18n.prop("total")+e.total+$.i18n.prop("record"))):$("#FileListPage").html("")}})}function getFeedback(){Util.ajax({url:"cc/getArticlesByLenovoID",data:{page:1,pageSize:1e3},success:function(e){if(0!=e.data.rows.length){$("#FeedbackMenu").addClass("hasFeed");var a="";$.each(e.data.rows,function(e,t){var s="";t.messageCount>0&&(s='<span class="badge">'+$.i18n.prop("replied")+"</span>");var i=t.messages[0]||"";a+='<li><a href="javascript:;" data-id="'+t.article_id+'" data-reply="'+i+'">'+s+'<span class="tit">'+t.context+"</span></a></li>"}),a+='<li class="divider"></li><li><a href="javascript:;" id="AddNewFeedbackLink"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp;'+$.i18n.prop("newFeedback")+"</a></li>",$("#FeedbackList").html(a),$("#AddNewFeedbackLink").click(function(){newFeedback()})}}})}function newFeedback(){var e=BootstrapDialog.show({title:$.i18n.prop("feedback"),cssClass:"feedback-dialog",message:'<div class="addValueDialog" id="AddValueDialog"><textarea class="form-control feedbackText" placeholder="'+$.i18n.prop("feedbackPlaceholder")+'" style="height:150px"></textarea><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewFeedbackBtn">'+$.i18n.prop("submit")+"</a></div></div>",onshown:function(){$("#AddNewFeedbackBtn").off("click").on("click",function(){$(this).addClass("disable");var a=$("#AddValueDialog .feedbackText").val();return""==a?(swal("Error",$.i18n.prop("feedbackNullTip")+"!","error"),void $("#AddNewFeedbackBtn").removeClass("disable")):void Util.ajax({url:"cc/savaArticle",data:{title:"",keyword:"",context:encodeURIComponent(a)},success:function(a){1==a.code?(swal($.i18n.prop("addSuccess")+"!","","success"),getFeedback(),e.close()):(swal("Error",a.data,"error"),$("#AddNewFeedbackBtn").removeClass("disable"))}})})}})}function bindEvent(){$("#Logout").click(function(){window.location.href="logout"}),$("#UserList").on("click","li",function(){$("#UserSel").html($(this).data("name")).data("user",$(this).data("user")),getJobList(),store.set(UserName+"user",$(this).data("user")+"||"+$(this).data("name"))}),$("#FeedbackList").on("click","a",function(){if("AddNewFeedbackLink"!=$(this).attr("id")){var e,a=($(this).attr("data-id"),$(this).attr("data-reply")),t=$(this).find(".tit").html();e=""!=a?'<div class="addValueDialog" id="AddValueDialog"><h4>'+$.i18n.prop("feedbackCon")+'</h4><div class="feedCon">'+t+"</div><h4>"+$.i18n.prop("adminReply")+'</h4><div class="replyCon">'+a+'</div><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewCloseBtn">'+$.i18n.prop("close")+"</a></div></div>":'<div class="addValueDialog" id="AddValueDialog"><div class="feedCon">'+t+'</div><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewCloseBtn">'+$.i18n.prop("close")+"</a></div></div>";var s=BootstrapDialog.show({title:$.i18n.prop("feedbackDetail"),cssClass:"feedback-dialog",message:e,onshown:function(){$("#AddNewCloseBtn").off("click").on("click",function(){s.close()})}})}}),$("#FeedbackMenu").on("click",function(){$(this).hasClass("hasFeed")||newFeedback()}),$("#DropdownUser").click(function(){setTimeout(function(){$("#UserKeyword").focus()},100)}),$("#FileFilter").keyup(function(e){switch(e.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:break;default:getJobList()}}),$("#FileOpts .btn").click(function(){$(this).toggleClass("active"),$(this).siblings().removeClass("active"),getJobList()})}function init(){getAppList(),bindEvent()}var _pathName=window.location.pathname;_pathName=_pathName.substring(1,_pathName.lastIndexOf("/")),window.UserName=$("#UserName").html()+"_"+_pathName+"_";var AppList={};init()});