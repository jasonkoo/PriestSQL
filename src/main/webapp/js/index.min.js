$(function(){function getTimeL(e){var t=Math.floor(e/864e5),a=Math.floor(e/36e5)-24*t,i=Math.floor(e/6e4)-24*t*60-60*a,s=Math.floor(e/1e3)-24*t*60*60-60*a*60-60*i,l=e-24*t*60*60*1e3-60*a*60*1e3-60*i*1e3-1e3*s,r=[];return t>0&&r.push(t+"d"),a>0&&r.push(a+"h"),i>0&&r.push(i+"m"),s>0&&r.push(s+"s"),l>0&&r.push(l+"ms"),r.join(":")}function html_encode(e){var t="";return null==e?"null":0==e.length?"":(t=e.replace(/&/g,"&amp;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/ /g,"&nbsp;"),t=t.replace(/\'/g,"&#39;"),t=t.replace(/\"/g,"&quot;"),t=t.replace(/\n/g,"<br>"))}function getActiveEditor(){return"CodeSql_"+$("#EditTable .cTab.active").data("target").split("e")[1]}function getKeyword(e){var t=/'(.*?)'/g,a=e.match(t);return $.each(a,function(e,t){a[e]=t.replace(new RegExp(/'/g),"")}),a}function hasLimit(e){var t=window[getActiveEditor()].getSelection();if(""!=t){var a=[];if(window[getActiveEditor()].doc.sel.ranges[0].anchor.line==window[getActiveEditor()].doc.sel.ranges[0].head.line){var i=window[getActiveEditor()].doc.sel.ranges[0].anchor.ch,s=window[getActiveEditor()].doc.sel.ranges[0].head.ch,l=i>s?s:i;if(4==e.split("||").length||"--"==e.substring(0,2))a.push(-l);else{for(var r=t.split(" "),n=!1,o=15,d=r.length-1;d!=-1;d--){if(n&&r[d].length>=5&&"limit"==r[d].substring(r[d].length-5).toLowerCase()){o=0;break}""!=r[d]&&(n=!0)}a.push(o-l)}}else a.push(0);var c=window[getActiveEditor()].doc.sel.ranges[0].anchor.line,p=window[getActiveEditor()].doc.sel.ranges[0].head.line,u=c>p?p:c;return a.push(u),a}if(window[getActiveEditor()].doc.size>1||4==e.split("||").length||"--"==e.substring(0,2))return 0;t=window[getActiveEditor()].getValue();for(var r=t.split(" "),n=!1,a=15,d=r.length-1;d!=-1;d--){if(n&&r[d].length>=5&&"limit"==r[d].substring(r[d].length-5).toLowerCase()){a=0;break}""!=r[d]&&(n=!0)}return a}function analyticError(e){var t=hasLimit(e),a=t,i=0;"object"==typeof t&&(a=t[0],i=t[1]);var s=[],l=[];if(4==e.split("||").length){var r=e.split("||");s[0]=parseInt(r[0])-1+i,s[1]=parseInt(r[1])-a,s[2]=s[1]+r[2].length,e=r[3]}else if(e.indexOf("Error 10001")>-1){var n=e.split(": ");n=n[n.length-1],s=n.split(" ")[1].split(":"),s[0]=parseInt(s[0])-1+i,s[1]=parseInt(s[1])-a;var o=getKeyword(n);null!=o?(o=o[0],l=[1,o],s[2]=window[getActiveEditor()].doc.getLineHandle(s[0]).text.indexOf(o)+o.length):s=[]}else if(e.indexOf("Parse sql error")>-1){var n=e.split(": ");n=n[1],s=n.split(" ")[1].split(":"),s[0]=parseInt(s[0])-1+i,s[1]=parseInt(s[1])-a;var o=getKeyword(n);null!=o?(n.indexOf("EOF")>-1?(s[2]=s[1]+o[1].length,s[1]=s[1]):n.indexOf("cannot recognize input near")>-1&&(s[2]=s[1]+o[0].length),l=[2]):s=[]}else if(e.indexOf("Error 10004")>-1){var n=e.split("[Error 10004]: ");n=n[1],s=n.split(" ")[1].split(":"),s[0]=parseInt(s[0])-1+i,s[1]=parseInt(s[1])-a;var o=getKeyword(n);null!=o?(s[2]=s[1]+o[0].length,l=[2]):s=[]}else if(e.indexOf("org.apache.spark.sql.AnalysisException")>-1){var n=e.split(" ");s[0]=parseInt(n[n.length-3])-1+i,s[1]=parseInt(n[n.length-1])-a;var o=getKeyword(e);null!=o?(s[2]=s[1]+o[0].length,l=[2]):s=[]}if(s.length>0&&s[1]>=0){l=[-1],window.CodeRange=window[getActiveEditor()].markText({line:s[0],ch:s[1]},{line:s[0],ch:s[2]},{className:"styled-background"});var d=document.createElement("div");d.setAttribute("class","alert alert-danger alertEditor"),"--"==e.substring(0,2)&&(e=e.substring(2));var c=document.createTextNode(e),p=document.createElement("i");p.setAttribute("class","fa fa-warning"),d.appendChild(p),d.appendChild(c),ErrorTip[getActiveEditor()]=window[getActiveEditor()].addLineWidget(s[0],d,{coverGutter:!0,noHScroll:!0})}return l}function codeEditor(e){function t(e,t){e.getCursor();return t&&!t()||setTimeout(function(){e.state.completionActive||e.showHint({completeSingle:!1})},100),CodeMirror.Pass}function a(e){return t(e,function(){var t=e.getTokenAt(e.getCursor());if("string"==t.type&&(!/['"]/.test(t.string.charAt(t.string.length-1))||1==t.string.length))return!1;var a=CodeMirror.innerMode(e.getMode(),t.state).state;return a.tagName})}var i=e.attr("id");window[i]=CodeMirror.fromTextArea(document.getElementById(i),{mode:"text/x-hive",indentWithTabs:!0,smartIndent:!0,lineNumbers:!0,matchBrackets:!0,autofocus:!1,styleSelectedText:!0,extraKeys:{"'a'":t,"'b'":t,"'c'":t,"'d'":t,"'e'":t,"'f'":t,"'g'":t,"'h'":t,"'i'":t,"'j'":t,"'k'":t,"'l'":t,"'m'":t,"'n'":t,"'o'":t,"'p'":t,"'q'":t,"'r'":t,"'s'":t,"'t'":t,"'u'":t,"'v'":t,"'w'":t,"'x'":t,"'y'":t,"'z'":t,"'.'":t,"'='":a,"Ctrl-Enter":"autocomplete",Tab:function(e){var t=Array(e.getOption("indentUnit")+1).join(" ");e.replaceSelection(t)}}}),window[i].on("change",function(){"undefined"!=typeof CodeRange&&CodeRange.clear(),"undefined"!=typeof ErrorTip[getActiveEditor()]&&window[getActiveEditor()].removeLineWidget(ErrorTip[getActiveEditor()]),store.set(UserName+"sql",window[getActiveEditor()].getValue())})}function resetDom(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),SuccessLogStatus[getActiveEditor()]=!1,SuccessResultStatus[getActiveEditor()]=!1,$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden").removeClass("has"),$("#ExportWrap").addClass("hidden"),$("#ExportAllDataTip").addClass("hidden"),$("#BtnExportAll").removeAttr("data-querykey"),$("#BtnExportAll").removeAttr("data-file"),$("#BtnExportAll").removeClass("disabled"),$("#DownloadLoading").addClass("hidden"),$("#LogCon").html(""),$("#ResultTip").hide(),$("#ResultTable").show(),$("#ResultListHeader").html(""),$("#ResultList").html(""),$("#ResultListPage").html("")}function setCookieData(){$("#CodeSql_1").val(store.get(UserName+"sql")),store.get(UserName+"tabName")&&($("#EditTable li").eq(0).find("span").html(store.get(UserName+"tabName")),$("#EditTable li").eq(0).find("span").attr("data-id",store.get(UserName+"tabId")),$(".cTab-pane.active").find(".btnSave").attr({"data-id":store.get(UserName+"tabId"),"data-alias":store.get(UserName+"tabName")}))}function getFeedback(){Util.ajax({url:"cc/getArticlesByLenovoID",data:{page:1,pageSize:1e3},success:function(e){if(0!=e.data.rows.length){$("#FeedbackMenu").addClass("hasFeed");var t="";$.each(e.data.rows,function(e,a){var i="";a.messageCount>0&&(i='<span class="badge">'+$.i18n.prop("replied")+"</span>");var s=a.messages[0]||"";t+='<li><a href="javascript:;" data-id="'+a.article_id+'" data-reply="'+s+'">'+i+'<span class="tit">'+a.context+"</span></a></li>"}),t+='<li class="divider"></li><li><a href="javascript:;" id="AddNewFeedbackLink"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp;'+$.i18n.prop("newFeedback")+"</a></li>",$("#FeedbackList").html(t),$("#AddNewFeedbackLink").click(function(){newFeedback()})}}})}function getAppList(){Util.ajax({url:"entry/getApplication",success:function(data){var _html='<div class="keywordSearch"><input type="text" class="form-control" id="UserKeyword" placeholder="Search..."></div><ul class="dropdownMenu">';$.each(data.data,function(e,t){_html+='<li data-user="'+t.appUser+'" data-name="'+t.appName+'"><a href="javascript:;">'+t.appName+"</a></li>",AppList[t.appUser]=t.appName}),_html+="</ul>",$("#UserList").html(_html),store.get(UserName+"user")&&void 0!=AppList[store.get(UserName+"user").split("||")[0]]?$("#UserSel").html(store.get(UserName+"user").split("||")[1]).data({user:store.get(UserName+"user").split("||")[0],name:store.get(UserName+"user").split("||")[1]}):$("#UserSel").html(data.data[0].appName).data({user:data.data[0].appUser,name:data.data[0].appName}),$("#UserKeyword").keyup(function(e){switch(e.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:break;default:$("#UserList").scrollTop(0),$("#UserList li").each(function(){if(!$(this).hasClass("keywordSearch")){var _keyword=$("#UserKeyword").val(),_thisHtml=$(this).attr("data-name");""!=_keyword?RegExp(_keyword,"i").test($(this).attr("data-name"))?(_thisHtml=_thisHtml.replace(eval("/("+_keyword+")/gi"),'<span class="key">$1</span>'),$(this).find("a").html(_thisHtml),$(this).show()):$(this).hide():(_thisHtml=_thisHtml.replace('<span class="key">',""),_thisHtml=_thisHtml.replace("</span>",""),$(this).find("a").html(_thisHtml),$(this).show())}})}})}})}function getConnectList(){Util.ajax({url:"ConnectController/getConnections",success:function(e){if(console.log(e),e.data.length>0){var t=e.data,a=store.get(UserName+"connSelName")||t[0].connectName,i=store.get(UserName+"connSelId")||t[0].id;ConnId=i,$("#ConnectChosen").Chosen({data:t,selectedVal:[a],chosenConWidth:237,idAlias:"id",nameAlias:"connectName",initCallback:function(){getDatabase(i)},selectedCallback:function(e,t){ConnId=e,getDatabase()}})}}})}function getDatabase(){var e="entry/getDataBases",t={ConnId:ConnId};Util.ajax({url:e,data:t,success:function(e){e=e.data,window.DatabaseList={};var t=store.get(UserName+"dbNameSel")||e[0].dbName,a=store.get(UserName+"dbIdSel")||e[0].dbId;if(null==e||0==e.length)return $("#DatabaseChosen").html("--"),$("#TableList").html("--"),$("#TableKeyword").addClass("hidden"),void $("#TableListPage").html("");$("#DatabaseChosen").Chosen({data:e,selectedVal:[t],chosenConWidth:237,idAlias:"dbId",nameAlias:"dbName",initCallback:function(){getTableList(a,t)},selectedCallback:function(e,t){getTableList(e,t)}});$.each(e,function(e,t){DatabaseList[t.dbName]=!0})}})}function getTableList(e,t,a){var i={ConnId:ConnId,dbId:e,dbName:t,page:a||1,pageSize:100},s="entry/getTables";Util.ajax({url:s,data:i,success:function(a){a=a.data,$("#TableList").scrollTop(0);var i="";window.db=[],$.each(a.rows,function(e,t){db.push(t.tblName);var a=null==t.partitions?"":t.partitions.join(",");i+='<li data-id="'+t.tblId+'" data-name="'+t.tblName+'" data-partitions="'+a+'"><a href="javascript:;"><i class="fa fa-table"></i><span data-toggle="tooltip" data-placement="top" title="'+t.tblName+'">'+t.tblName+"</span></a></li>"}),""==i?($("#TableList").html("--"),$("#TableKeyword").addClass("hidden")):($("#TableList").html(i),a.rows.length>10?$("#TableKeyword").removeClass("hidden"):$("#TableKeyword").addClass("hidden")),a.total>100?($("#TableListPage").html('<div class="inner"></div>'),$("#TableListPage .inner").bootpag({total:Math.ceil(a.total/100),page:a.page,maxVisible:5,leaps:!1}).on("page",function(a,i){getTableList(e,t,i)})):$("#TableListPage").html("")}})}function getQueryHistory(){Util.ajax({url:"getQueryHistory",success:function(e){var t="";$.each(e.data,function(e,a){var i,s;"H"==a.queryType?s="MR":"S"==a.queryType?s="Spark":"M"==a.queryType?s="Mysql":"I"==a.queryType&&(s="Impala"),2==a.runningState?i='<span class="label label-success">'+$.i18n.prop("success")+"</span>":1==a.runningState?i='<span class="label label-info">'+$.i18n.prop("running")+"</span>":0==a.runningState?i='<span class="label label-warning">'+$.i18n.prop("killed")+"</span>":a.runningState==-1&&(i='<span class="label label-danger">'+$.i18n.prop("failed")+"</span>");var l=a.sql.replace(new RegExp(/"/g),"");t+="<tr><td>"+new Date(a.date).Format("yyyy-MM-dd hh:mm:ss")+'</td><td><div class="sqlCon" title="'+l+'"><code>'+l.substring(0,120)+"...</code></div></td><td>"+s+"</td><td>"+i+'</td><td><a href="javascript:;" class="detail" data-appname="'+a.appName+'" data-dbname="'+a.dbName+'" data-state="'+a.runningState+'" data-id="'+a.id+'" data-queryType="'+a.queryType+'" data-logKey="'+a.logKey+'" data-queryCountKey="'+a.queryCountKey+'" data-queryKey="'+a.queryKey+'" data-proxyUser="'+a.proxyUser+'" data-sql="'+encodeURIComponent(a.sql)+'">'+$.i18n.prop("showResult")+"</a></td></tr>"}),$("#HistoryList").html(t)}})}function getQueryList(e){var t={type:2,page:e||1,pageSize:100};Util.ajax({url:"entry/getCustomEntryList",data:t,success:function(e){if($("#QueryList").scrollTop(0),0==e.data.total)return void $("#QueryList").html("--"+$.i18n.prop("noResult")+"--");e=e.data;var t="";$.each(e.rows,function(e,a){t+='<li><a href="javascript:;" data-id="'+a.id+'" class="item"><i class="fa fa-file-code-o"></i><span data-toggle="tooltip" data-placement="top" title="'+a.alias+'">'+a.alias+'<label title="'+a.context+'">('+a.context+')</label></span></a><a href="javascript:;" class="del" data-id="'+a.id+'" title="'+$.i18n.prop("delRecord")+'"><i class="fa fa-trash-o" aria-hidden="true"></i></a></li>'}),$("#QueryList").html(t),e.total>100?($("#QueryListPage").html('<div class="inner"></div>'),$("#QueryListPage .inner").bootpag({total:Math.ceil(e.total/100),page:e.pageIndex,maxVisible:5}).on("page",function(e,t){getTableList(dbId,dbName,t)})):$("#QueryListPage").html("")}})}function getResultList(e){if(!(SuccessResultStatus[getActiveEditor()]&&"undefined"==typeof e||null==QueryKey[getActiveEditor()])||(0==$("#ResultList").find(".label-success").length&&$("#ExportWrap").removeClass("hidden"),Downloading[getActiveEditor()])){var t={queryKey:QueryKey[getActiveEditor()],queryCountKey:QueryCountKey[getActiveEditor()],page:e||1,pageSize:100};Util.ajax({url:"query",data:t,success:function(e){if(0==e.code){if(!ErrorStatus[getActiveEditor()])if("object"==typeof e.data)swal("Error",e.data[0],"error");else{var t=analyticError(e.data);t[0]!=-1&&swal({title:"Error",text:e.data,type:"error",html:!0})}$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),$("#ResultTip").hide(),$("#ResultTable").show();var a;return a="object"==typeof e.data?e.data[1]:e.data,$("#ResultList").html('<p><span class="label label-danger">'+$.i18n.prop("runError")+"---</span></p>"+a.replace(new RegExp(/\n/g),"<br/>")),void(ErrorStatus[getActiveEditor()]=!0)}if(1==e.code){e=e.data;if("processing..."==e)return $("#ResultTip").show(),$("#ResultTable").hide(),$("#EditOpts .btRunSpark").addClass("hidden"),$("#EditOpts .btRunHive").addClass("hidden"),$("#EditOpts .btStop").removeClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),TimerResult=setInterval(function(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),getResultList()},1e3),!1;if("undefined"!=typeof TimerResult&&clearInterval(TimerResult),SuccessResultStatus[getActiveEditor()]=!0,$("#ResultTip").hide(),$("#ResultTable").show(),$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),"finished"==e)return $("#ResultList").html('<span class="label label-success">'+$.i18n.prop("finishedNoResult")+"!</span>"),$("#ExportWrap").addClass("hidden"),!1;if($("#ResultListHeader").html(""),$("#ResultList").html(""),$("#ResultListPage").html(""),0==e.rows.length)$("#ResultList").html('<span class="label label-success">'+$.i18n.prop("finishedNoResult")+"!</span>"),$("#ExportWrap").addClass("hidden");else{$("#ExportWrap").removeClass("hidden"),1e3==e.total?($("#BtnExportAll").removeClass("hidden"),void 0!=QueryDownloadKey[getActiveEditor()]&&($("#BtnExportAll").attr("data-querykey",QueryDownloadKey[getActiveEditor()]),void 0!=QueryDownloadFile[getActiveEditor()]&&$("#BtnExportAll").attr("data-file",!0)),Downloading[getActiveEditor()]&&($("#BtnExportAll").addClass("disabled"),$("#ExportAllDataTip").removeClass("hidden"),$("#DownloadLoading").removeClass("hidden"),getDownloadFile())):$("#BtnExportAll").addClass("hidden");var i="<th>#</th>",s=[];$.each(e.rows[0],function(e,t){i+=e.indexOf(".")>-1?"<th>"+e.split(".")[1]+"</th>":"<th>"+e+"</th>",s.push(e)}),$("#ResultListHeader").html("<tr>"+i+"</tr>"),i="",$.each(e.rows,function(t,a){i+='<tr><td class="rowNum">'+(t+1+100*(e.pageIndex-1))+"</td>",$.each(s,function(e,t){i+="<td>"+html_encode(a[t])+"</td>"}),i+="</tr>"}),$("#ResultList").html(i),e.total>0?($("#ResultListPage").html('<div class="inner"></div>'),$("#ResultListPage .inner").bootpag({total:Math.ceil(e.total/100),page:e.pageIndex,maxVisible:10}).on("page",function(e,t){getResultList(t)})):$("#ResultListPage").html("")}}else 3==e.code&&("undefined"!=typeof TimerResult&&clearInterval(TimerResult),SuccessResultStatus[getActiveEditor()]=!0,$("#ResultTip").hide(),$("#ResultTable").show(),$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),$("#ResultList").html('<span class="label label-success">'+$.i18n.prop("dataExpire")+"!</span>"))}})}}function getDownloadKey(){var _sql=window[getActiveEditor()].getSelection();""==_sql&&(_sql=window[getActiveEditor()].getValue()),$.each(SqlParam[getActiveEditor()],function(k,v){var _reg="/"+k.replace("$","\\$")+"/g";_sql=_sql.replace(eval(_reg),v)});var _param={sql:_sql,ConnId:ConnId,pageSize:100,dbName:$("#DatabaseChosen .fixedVal").val(),queryKey:QueryKey[getActiveEditor()],proxyUserName:QueryUser[getActiveEditor()],appName:QueryAppName[getActiveEditor()],forBigData:1};Util.ajax({url:"applySql",data:_param,success:function(e){if(1==e.code)QueryDownloadKey[getActiveEditor()]=e.data.queryKey,$("#BtnExportAll").attr("data-querykey",e.data.queryKey),getDownloadFile();else{$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden");var t=analyticError(e.data);t[0]!=-1&&swal("Error",e.data,"error")}}})}function getDownloadFile(){var e={queryKey:QueryDownloadKey[getActiveEditor()],queryCountKey:QueryCountKey[getActiveEditor()],forBigData:1};Util.ajax({url:"query",data:e,success:function(e){if(0==e.code)ErrorStatusDownload[getActiveEditor()]||("object"==typeof e.data?swal("Error",e.data[0],"error"):swal("Error",e.data,"error")),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),ErrorStatusDownload[getActiveEditor()]=!0;else if(1==e.code){e=e.data;"processing..."==e?($("#ExportAllDataTip").removeClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),TimerResult=setInterval(function(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),getDownloadFile()},1e3)):("undefined"!=typeof TimerResult&&clearInterval(TimerResult),$("#ExportAllDataTip").addClass("hidden"),$("#BtnExportAll").attr("data-file",!0),QueryDownloadFile[getActiveEditor()]=!0,$("#ExportAllDataTip").addClass("hidden"),$("#DownloadLoading").addClass("hidden"),DownloadFile.indexOf(QueryKey[getActiveEditor()])==-1&&($.exportExcel({queryKey:QueryDownloadKey[getActiveEditor()],forBigData:1,url:"downloadFile"}),$("#BtnExportAll").removeClass("disabled"),DownloadFile.push(QueryKey[getActiveEditor()])),Downloading[getActiveEditor()]=!1)}else 3==e.code&&("undefined"!=typeof TimerResult&&clearInterval(TimerResult),$("#ExportAllDataTip").removeClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),TimerResult=setInterval(function(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),getDownloadFile()},1e3))}})}function getResultLog(){SuccessLogStatus[getActiveEditor()]||null==QueryKey[getActiveEditor()]||(RunningTab=getActiveEditor(),Util.ajax({url:"logs",data:{logKey:LogKey[getActiveEditor()],queryKey:QueryKey[getActiveEditor()],queryCountKey:QueryCountKey[getActiveEditor()]},success:function(e){if(RunningTab==getActiveEditor()){if(0==e.code){if(!ErrorStatus[getActiveEditor()])if("object"==typeof e.data)swal("Error",e.data[0],"error");else{var t=analyticError(e.data);t[0]!=-1&&swal({title:"Error",text:e.data,type:"error",html:!0})}ErrorStatus[getActiveEditor()]=!0,$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult);var a;a="object"==typeof e.data?e.data[1]:e.data;var i=QueryHistory[getActiveEditor()]?"":'<p><span class="label label-primary">'+$.i18n.prop("taskStart")+"---</span></p>";return $("#LogCon").html(i),4==a.split("||").length&&(a=a.split("||")[3]),void $("#LogCon").append('<p><span class="label label-danger">'+$.i18n.prop("runError")+"---</span></p>"+a.replace(new RegExp(/\n/g),"<br/>"))}if(1==e.code){var i=QueryHistory[getActiveEditor()]?"":'<p><span class="label label-primary">'+$.i18n.prop("taskStart")+"---</span></p>";$("#LogCon").html(i);var s="";null!=e.data&&"there is no available logs"!=e.data&&(void 0!=e.data.sparkLog?$.each(e.data.sparkLog,function(e,t){var a;a="100%"==t.percent?'<span class="label label-success">100%</span>':'<span class="label label-info">'+t.percent+"</span>",s+="<p><b>JobID: "+t.jobid+"</b>&nbsp;&nbsp;"+a+"</p>",$.each(t.log,function(e,t){s+=t+"<br/>"}),s+='<div class="logDivider"></div>'}):"object"!=typeof e.data&&(s=e.data.replace(new RegExp(/\n/g),"<br/>"))),$("#LogCon").append(s),$("#EditOpts .btRunSpark").addClass("hidden"),$("#EditOpts .btRunHive").addClass("hidden"),$("#EditOpts .btStop").removeClass("hidden")}if(2==e.code){var i=QueryHistory[getActiveEditor()]?"":'<p><span class="label label-primary">'+$.i18n.prop("taskStart")+"---</span></p>";$("#LogCon").html(i);var l,s="";if(null!=e.data)if(void 0!=e.data.sparkLog){$.each(e.data.sparkLog,function(e,t){var a;a="100%"==t.percent?'<span class="label label-success">100%</span>':'<span class="label label-info">'+t.percent+"</span>",s+="<p><b>JobID: "+t.jobid+"</b>&nbsp;&nbsp;"+a+"</p>",$.each(t.log,function(e,t){s+=t+"<br/>"}),s+='<div class="logDivider"></div>'});var r=e.data["time cost"].split("||"),n=parseInt(r[0]),o=parseInt(r[1]||0);if(n<o){var d=o;o=n,n=d}if(0==o)l="<p>"+$.i18n.prop("totalTime")+'：<span class="label label-primary">'+getTimeL(n)+"</span></p>";else{var c=n-o;l="<p>"+$.i18n.prop("totalTime")+'：<span class="label label-primary">'+getTimeL(n)+"</span>,&nbsp;&nbsp;"+$.i18n.prop("waitTime")+'：<span class="label label-primary">'+getTimeL(o)+"</span>, "+$.i18n.prop("runTime")+'：<span class="label label-primary">'+getTimeL(c)+"</span></p>"}}else if("object"!=typeof e.data){var p=e.data.split("||"),o=parseInt(p.pop()||0),n=parseInt(p.pop());if(n<o){var d=o;o=n,n=d}if(0==o)l="<p>"+$.i18n.prop("totalTime")+'：<span class="label label-primary">'+getTimeL(n)+"</span></p>";else{var c=n-o;l="<p>"+$.i18n.prop("totalTime")+'：<span class="label label-primary">'+getTimeL(n)+"</span>,&nbsp;&nbsp;"+$.i18n.prop("waitTime")+'：<span class="label label-primary">'+getTimeL(o)+"</span>, "+$.i18n.prop("runTime")+'：<span class="label label-primary">'+getTimeL(c)+"</span></p>"}"there is no available logs"!=p.join("||")&&(s=p.join("||").replace(new RegExp(/\n/g),"<br/>"))}$("#LogCon").append(s);var u='<p style="margin-top: 10px;"><span class="label label-success">'+$.i18n.prop("taskFinished")+"!</span></p>";$("#LogCon").append(u),$("#LogCon").append(l),$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),"undefined"!=typeof TimerResult&&clearInterval(TimerResult),SuccessLogStatus[getActiveEditor()]=!0,SuccessResultStatus[getActiveEditor()]||setTimeout(function(){$("#ResultTab li").eq(1).click()},500)}else"undefined"!=typeof TimerResult&&clearInterval(TimerResult),TimerResult=setInterval(function(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),getResultLog()},1e3)}}}))}function getResult(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),"undefined"!=typeof QueryKey[getActiveEditor()]&&("#LogCon"==$("#ResultTab li.active").data("target")?($("#ExportWrap").addClass("hidden"),getResultLog()):"#ResultCon"==$("#ResultTab li.active").data("target")&&getResultList())}function getQueryDetail(e){Util.ajax({url:"entry/getCustomEntryById",data:{id:e},success:function(e){e=e.data;var t=!1;$("#EditTable li").each(function(){if($(this).find("span").attr("data-id")==e[0].id)return $(this).mousedown(),t=!0,setSqlCookie(),!1}),t||(5==$("#EditTable li").length?$("#EditTable li.active").click():$("#AddTab").click(),$("#EditTable .cTab.active").find("span").html(e[0].alias).attr("data-id",e[0].id),window[getActiveEditor()].setValue(e[0].context),window[getActiveEditor()].setCursor(1,0),$(".cTab-pane.active").find(".btnSave").attr({"data-alias":e[0].alias,"data-id":e[0].id}),setSqlCookie())}})}function delQuery(e){Util.ajax({url:"entry/delCustomEntry?id="+e,type:"get",success:function(t){1==t.code?(swal($.i18n.prop("delSuccess")+"!","","success"),getQueryList(),$(".btnSave").each(function(){$(this).attr("data-id")&&$(this).attr("data-id")==e&&$(this).removeAttr("data-id")})):swal("Error",t.data,"error")}})}function newFeedback(){var e=BootstrapDialog.show({title:$.i18n.prop("feedback"),cssClass:"feedback-dialog",message:'<div class="addValueDialog" id="AddValueDialog"><textarea class="form-control feedbackText" placeholder="'+$.i18n.prop("feedbackPlaceholder")+'" style="height:150px"></textarea><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewFeedbackBtn">'+$.i18n.prop("submit")+"</a></div></div>",onshown:function(){$("#AddNewFeedbackBtn").off("click").on("click",function(){$(this).addClass("disable");var t=$("#AddValueDialog .feedbackText").val();return""==t?(swal("Error",$.i18n.prop("feedbackNullTip")+"!","error"),void $("#AddNewFeedbackBtn").removeClass("disable")):void Util.ajax({url:"cc/savaArticle",data:{title:"",keyword:"",context:encodeURIComponent(t)},success:function(t){1==t.code?(swal($.i18n.prop("addSuccess")+"!","","success"),getFeedback(),e.close()):(swal("Error",t.data,"error"),$("#AddNewFeedbackBtn").removeClass("disable"))}})})}})}function getStatusInfo(){$.ajax({url:"jobList",success:function(e){e&&($("#InfoRunning").html(e.RUNNING),$("#InfoQueue").html(e.ACCEPTED))}})}function setSqlCookie(){$("#EditTable li.active").find("span").data("id")&&(store.set(UserName+"tabName",$("#EditTable li.active").find("span").html()),store.set(UserName+"tabId",$("#EditTable li.active").find("span").attr("data-id")),store.set(UserName+"sql",window[getActiveEditor()].getValue()))}function setSqlParam(){var e=window[getActiveEditor()].getSelection();""==e&&(e=window[getActiveEditor()].getValue());var t=e.match(/\$\{[^\}]+\}/g);t=t.distinct();var a="";$.each(t,function(e,t){a+='<div class="paramList"><label>'+t.replace("${","").replace("}","")+'</label><input type="text" class="form-control" data-name="'+t+'"></div>'});var i=BootstrapDialog.show({title:$.i18n.prop("setParam"),cssClass:"param-dialog",message:a+'<a href="javascript:;" class="btn btn-primary" id="SetParamBtn">'+$.i18n.prop("sure")+"</a>",onshown:function(){$("#SetParamBtn").click(function(){var e=[],a=!0;$(".paramList").each(function(){var t=$(this).find(".form-control").val();return""==t?(swal("",$.i18n.prop("paramTip")+"！","error"),a=!1,!1):void e.push(t)}),a&&($.each(t,function(t,a){SqlParam[getActiveEditor()][a]=e[t]}),i.close(),$("#EditOpts .btRunSpark").addClass("hidden"),$("#EditOpts .btRunHive").addClass("hidden"),$("#EditOpts .btStop").removeClass("hidden"),$(".cTab-pane.active").find(".btnRun").click())})}})}function stopTask(){return void 0==QueryKey[getActiveEditor()]?void setTimeout(function(){stopTask()},1e3):QueryKey[getActiveEditor()]==-1?void swal.close():void Util.ajax({url:"cancelJob",data:{logKey:LogKey[getActiveEditor()],queryKey:QueryKey[getActiveEditor()]},success:function(e){1==e.code?($("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden"),swal($.i18n.prop("taskKilled"),"","success"),$("#LogCon").append('<p style="margin-top: 10px;"><span class="label label-success">'+$.i18n.prop("taskKilled")+"---</span></p>"),QueryKey[getActiveEditor()]=void 0,$("#ResultTip").hide(),$("#ResultTable").show(),$("#ResultList").html('<p style="margin-top: 10px;"><span class="label label-success">'+$.i18n.prop("taskKilled")+"---</span></p>")):swal($.i18n.prop("killFailed"),"","error"),$("#EditOpts .btStop").removeClass("has")}})}function bindEvent(){$('[data-toggle="tooltip"]').tooltip(),ChromeTab=$("#EditTable").chromeTab({newTabCallback:function(){resetDom(),setSqlCookie()},changeTabCallback:function(){$("#ResultTab li").eq(0).addClass("active"),$("#ResultTab li").eq(1).removeClass("active"),$("#ResultTab li").eq(2).removeClass("active"),$("#LogCon").addClass("active"),$("#ResultCon").removeClass("active"),$("#HistoryCon").removeClass("active"),resetDom(),getResult(),setSqlCookie()},closeCallback:function(){$("#ResultTab li").eq(0).addClass("active"),$("#ResultTab li").eq(1).removeClass("active"),$("#ResultTab li").eq(2).removeClass("active"),$("#LogCon").addClass("active"),$("#ResultCon").removeClass("active"),$("#HistoryCon").removeClass("active"),resetDom(),getResult(),setSqlCookie()},editorInit:function(e){codeEditor(e)}}),$("#TableList").on("click","li",function(){var e=$(this).attr("data-name"),t=$("#DatabaseChosen .fixedVal").val(),a=window[getActiveEditor()].getValue();if(a=a+" "+t+"."+e+" ",""!=$(this).attr("data-partitions")){var i=[];$.each($(this).attr("data-partitions").split(","),function(e,t){i.push(t+"=''")}),a+="WHERE "+i.join(" AND ")}window[getActiveEditor()].setValue(a)}),$("#TableKeyword").keyup(function(e){switch(e.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:break;default:var _keyword=$(this).val();if(""==_keyword)getTableList($("#DatabaseChosen .fixedId").val(),$("#DatabaseChosen .fixedVal").val());else{$("#TableList").scrollTop(0);var _param={dbId:$("#DatabaseChosen .fixedId").val(),tblName:_keyword,page:1,pageSize:1e5};Util.ajax({url:"entry/getTables",data:_param,success:function(data){data=data.data,$("#TableListPage").scrollTop(0);var _html="";0==data.rows.length||$.each(data.rows,function(k,v){var _thisHtml=v.tblName.replace(eval("/("+_keyword+")/gi"),"<b>$1</b>");_html+='<li data-id="'+v.tblId+'" data-name="'+v.tblName+'" data-partitions="'+v.partitions.join(",")+'"><a href="javascript:;"><i class="fa fa-table"></i><span data-toggle="tooltip" data-placement="top" title="'+v.tblName+'">'+_thisHtml+"</span></a></li>"}),$("#TableList").html(_html),$("#TableListPage").html('<div class="inner"></div>')}})}}}),$(".cTab-content").on("click",".btnSave",function(){var e=$(this),t=BootstrapDialog.show({title:$.i18n.prop("addAlias"),cssClass:"alias-dialog",message:'<div class=""><input type="text" class="form-control" id="AliasName"><a href="javascript:;" class="btn btn-primary" id="SaveSqlBtn">确定</a></div>',onshown:function(){e.attr("data-alias")&&$("#AliasName").val(e.attr("data-alias")),$("#SaveSqlBtn").click(function(){var a=$("#AliasName").val();if(""==a)return void swal("",$.i18n.prop("aliasNullTip")+"！","error");if(a.length>25)return void swal("",$.i18n.prop("aliasLangTip")+"！","error");var i={type:e.parent().find('input[type="radio"]:checked').attr("data-val"),alias:a,context:window[e.data("code")].getValue(),pid:2},s="entry/savaCustomEntry";e.attr("data-id")&&($("#AliasName").val(e.attr("data-alias")),$.extend(i,{id:e.attr("data-id")}),s="entry/updateCustomEntry"),Util.ajax({url:s,data:i,success:function(i){1==i.code?(t.close(),swal("Save Successful!","","success"),e.attr("data-alias",a),e.attr("data-id",i.data),$("#EditTable .cTab.active").find("span").html(a).attr("data-id",i.data),getQueryList()):swal("Error",$.i18n.prop("aliasRepeat")+"！","error")}})})}})}),$(".cTab-content").on("click",".btnRun",function(){"undefined"!=typeof CodeRange&&CodeRange.clear();var _self=$(this),_sql=window[_self.data("code")].getSelection();""==_sql&&(_sql=window[_self.data("code")].getValue()),$.each(SqlParam[getActiveEditor()],function(k,v){var _reg="/"+k.replace("$","\\$")+"/g";_sql=_sql.replace(eval(_reg),v)}),QueryStop[getActiveEditor()]=!1,ErrorStatus[getActiveEditor()]=!1,SuccessLogStatus[getActiveEditor()]=!1,SuccessResultStatus[getActiveEditor()]=!1,QueryHistory[getActiveEditor()]=!1,$("#ResultTab li").eq(0).addClass("active"),$("#ResultTab li").eq(1).removeClass("active"),$("#ResultTab li").eq(2).removeClass("active"),$("#LogCon").addClass("active"),$("#ResultCon").removeClass("active"),$("#HistoryCon").removeClass("active"),$("#ExportWrap").addClass("hidden"),$("#ExportAllDataTip").addClass("hidden"),$("#BtnExportAll").removeAttr("data-querykey"),$("#BtnExportAll").removeAttr("data-file"),$("#BtnExportAll").removeClass("disabled"),$("#DownloadLoading").addClass("hidden"),QueryDownloadKey[getActiveEditor()]=void 0,
RunningTab=getActiveEditor(),QueryStop[getActiveEditor()]=void 0;var _param={ConnId:ConnId,sql:_sql,pageSize:100,dbName:$("#DatabaseChosen .fixedVal").val(),proxyUserName:$("#UserSel").data("user"),appName:$("#UserSel").data("name")};QueryUser[getActiveEditor()]=$("#UserSel").data("user"),QueryAppName[getActiveEditor()]=$("#UserSel").data("name"),Util.ajax({url:"applySql",data:_param,success:function(e){if(RunningTab==getActiveEditor())if(1==e.code){if(QueryKey[RunningTab]=e.data.queryKey,LogKey[RunningTab]=e.data.logKey,QueryCountKey[RunningTab]=e.data.queryCountKey,"undefined"!=typeof QueryStop[getActiveEditor()])return;$("#ResultListHeader").html(""),$("#ResultList").html(""),$("#ResultListPage").html(""),$("#ResultTip").hide(),$("#LogCon").html(""),getResult()}else{QueryKey[RunningTab]==-1,$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden");var t=analyticError(e.data);t[0]!=-1&&swal("Error",e.data,"error")}}})}),$(".cTab-content").on("click",".btnStop",function(){"undefined"!=typeof TimerResult&&clearInterval(TimerResult),QueryStop[getActiveEditor()]=!0;$(this),{logKey:LogKey[getActiveEditor()]};swal({title:$.i18n.prop("stopping"),text:"",type:"warning",showConfirmButton:!1}),stopTask()}),$("#EditOpts .btSave").click(function(){$(".cTab-pane.active").find(".btnSave").click()}),$("#EditOpts .btFormat").click(function(){var e=window[getActiveEditor()].getValue();Util.ajax({url:"formateSql",data:{sql:e},success:function(e){var t=e.data.replace(new RegExp(/\n    /g),"\n");t=t.substring(1),window[getActiveEditor()].setValue(t)}})}),$("#EditOpts .btRunSpark").click(function(){"undefined"!=typeof ErrorTip[getActiveEditor()]&&window[getActiveEditor()].removeLineWidget(ErrorTip[getActiveEditor()]);var e=window[getActiveEditor()].getSelection();""==e&&(e=window[getActiveEditor()].getValue()),""!=e&&(null!=e.match(/\$\{[^\}]+\}/g)&&e.match(/\$\{[^\}]+\}/g).length>0?(SqlParam[getActiveEditor()]={},setSqlParam()):($("#EditOpts .btRunSpark").addClass("hidden"),$("#EditOpts .btRunHive").addClass("hidden"),$("#EditOpts .btStop").removeClass("hidden"),$(".cTab-pane.active").find(".btnRun").click()))}),$("#EditOpts .btRunHive").click(function(){"undefined"!=typeof ErrorTip[getActiveEditor()]&&window[getActiveEditor()].removeLineWidget(ErrorTip[getActiveEditor()]);var e=window[getActiveEditor()].getSelection();""==e&&(e=window[getActiveEditor()].getValue()),""!=e&&(null!=e.match(/\$\{[^\}]+\}/g)&&e.match(/\$\{[^\}]+\}/g).length>0?(SqlParam[getActiveEditor()]={},setSqlParam()):($("#EditOpts .btRunSpark").addClass("hidden"),$("#EditOpts .btRunHive").addClass("hidden"),$("#EditOpts .btStop").removeClass("hidden"),$(".cTab-pane.active").find(".btnRun").click()))}),$("#EditOpts .btStop").click(function(){$(this).hasClass("has")||($(this).addClass("has"),$(".cTab-pane.active").find(".btnStop").click())}),$("#EditOpts .btUndo").click(function(){window[getActiveEditor()].getHistory()}),$("#EditOpts .btRedo").click(function(){window[getActiveEditor()].setHistory()}),$("#ResultTab li").click(function(){"undefined"!=typeof TimerResultTab&&clearInterval(TimerResultTab),TimerResultTab=setTimeout(function(){"#HistoryCon"==$("#ResultTab li.active").data("target")?($("#ExportWrap").addClass("hidden"),getQueryHistory()):getResult()},100)}),$("#FeedbackList").on("click","a",function(){if("AddNewFeedbackLink"!=$(this).attr("id")){var e,t=($(this).attr("data-id"),$(this).attr("data-reply")),a=$(this).find(".tit").html();e=""!=t?'<div class="addValueDialog" id="AddValueDialog"><h4>'+$.i18n.prop("feedbackCon")+'</h4><div class="feedCon">'+a+"</div><h4>"+$.i18n.prop("adminReply")+'</h4><div class="replyCon">'+t+'</div><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewCloseBtn">'+$.i18n.prop("close")+"</a></div></div>":'<div class="addValueDialog" id="AddValueDialog"><div class="feedCon">'+a+'</div><div class="btnWrap"><a href="javascript:;" class="btn btn-primary" id="AddNewCloseBtn">'+$.i18n.prop("close")+"</a></div></div>";var i=BootstrapDialog.show({title:$.i18n.prop("feedbackDetail"),cssClass:"feedback-dialog",message:e,onshown:function(){$("#AddNewCloseBtn").off("click").on("click",function(){i.close()})}})}}),$("#FeedbackMenu").on("click",function(){$(this).hasClass("hasFeed")||newFeedback()}),$("#QueryList").on("click",".item",function(){getQueryDetail($(this).attr("data-id"))}),$("#QueryList").on("click",".del",function(e){delQuery($(this).attr("data-id"))}),$("#HistoryList").on("click",".detail",function(){var e=$(this).data("id"),t=($(this).data("querytype"),$(this).data("logkey")),a=$(this).data("querycountkey"),i=$(this).data("querykey"),s=decodeURIComponent($(this).data("sql")),l=$(this).data("state"),r=$(this).data("dbname"),n=$(this).data("proxyuser"),o=$(this).data("appname"),d=!1;2==l?$("#ResultTab li").eq(1).click():$("#ResultTab li").eq(0).click(),$("#DatabaseChosen .fixedText").html(r),$("#DatabaseChosen .fixedVal").val(r),$("#DatabaseChosen .dataListAll li").each(function(){if($(this).attr("thisval")==r)return $("#DatabaseChosen .fixedId").val($(this).attr("thisid")),getTableList($(this).attr("thisid"),$(this).attr("thisval")),!1}),$("#UserSel").html(AppList[n]).data({user:n,name:o}),$("#EditTable li").each(function(){if($(this).find("span").html()==$.i18n.prop("queryRecord")+"-"+e)return $(this).mousedown(),d=!0,$(".cTab-pane.active").find(".btnSave").removeAttr("data-alias","data-id"),$("#EditOpts .btRunSpark").removeClass("hidden"),$("#EditOpts .btRunHive").removeClass("hidden"),$("#EditOpts .btStop").addClass("hidden").removeClass("has"),$("#ResultListHeader").html(""),$("#ResultList").html(""),$("#ResultListPage").html(""),$("#ResultTip").hide(),$("#LogCon").html(""),getResult(),setSqlCookie(),!1}),d||(5==$("#EditTable li").length?$("#EditTable li.active").click():$("#AddTab").click(),$("#EditTable .cTab.active").find("span").html($.i18n.prop("queryRecord")+"-"+e).removeAttr("id"),window[getActiveEditor()].setValue(s),window[getActiveEditor()].setCursor(1,0),LogKey[getActiveEditor()]=t,QueryCountKey[getActiveEditor()]=a,QueryKey[getActiveEditor()]=i,QueryHistory[getActiveEditor()]=!0,QueryUser[getActiveEditor()]=n,$(".cTab-pane.active").find(".btnSave").removeAttr("data-alias","data-id"),$("#ResultListHeader").html(""),$("#ResultList").html(""),$("#ResultListPage").html(""),$("#ResultTip").hide(),$("#LogCon").html(""),getResult(),setSqlCookie())}),$("#BtnExport").on("click",function(){$.exportExcel({queryKey:QueryKey[getActiveEditor()],url:"downloadFile"})}),$("#BtnExportAll").on("click",function(){$(this).attr("data-querykey")?$(this).attr("data-file")?$.exportExcel({queryKey:QueryDownloadKey[getActiveEditor()],forBigData:1,url:"downloadFile"}):(Downloading[getActiveEditor()]=!0,$(this).addClass("disabled"),getDownloadFile()):(Downloading[getActiveEditor()]=!0,$(this).addClass("disabled"),$("#ExportAllDataTip").removeClass("hidden"),$("#DownloadLoading").removeClass("hidden"),getDownloadKey())}),$("#Logout").click(function(){store.set(UserName+"sql",window[getActiveEditor()].getValue()),window.location.href="logout"}),$("#QueryListTab li").click(function(){$(this).addClass("active").siblings().removeClass("active"),$($(this).data("target")).addClass("active").siblings().removeClass("active")}),$("#UserList").on("click","li",function(){$(this).hasClass("keywordSearch")||($("#UserSel").html($(this).data("name")).data({user:$(this).data("user"),name:$(this).data("name")}),store.set(UserName+"user",$(this).data("user")+"||"+$(this).data("name")))}),$("#DropdownUser").click(function(){setTimeout(function(){$("#UserKeyword").focus()},100)}),$("#AddConn").click(function(){var e=BootstrapDialog.show({title:"添加连接",cssClass:"loadFile-dialog",message:'<div class="addValueDialog form-horizontal" id="AddValueDialog" style="margin: 0 15px;font-size: 12px;"><div class="form-group"><label class="col-sm-3 control-label">连接名</label><div class="col-sm-9"><input class="form-control connName" type="text"></div></div><div class="form-group"><label class="col-sm-3 control-label">连接类型</label><div class="col-sm-9"><select class="form-control connType"><option value="mysql">mysql</option><option value="impala">impala</option><option value="hive">hive</option><option value="spark">spark</option></select></div></div><div class="form-group"><label class="col-sm-3 control-label">连接url</label><div class="col-sm-9"><input class="form-control connUrl" type="text"></div></div><div class="form-group"><label class="col-sm-3 control-label">连接驱动</label><div class="col-sm-9"><input class="form-control connDriver" type="text"></div></div><div class="form-group"><label class="col-sm-3 control-label">用户名</label><div class="col-sm-9"><input class="form-control connUser" type="text"></div></div><div class="form-group"><label class="col-sm-3 control-label">密码</label><div class="col-sm-9"><input class="form-control connPasswd" type="password"></div></div><div class="form-group"><label class="col-sm-3 control-label">是否公开</label><div class="col-sm-9"><span class="radio" style="display: inline-block; margin-right: 20px;"><label><input type="radio" name="optionsRadios" id="optionsRadios1" value="all" checked>公开</label></span><span class="radio" style="display: inline-block; margin-right: 20px;"><label><input type="radio" name="optionsRadios" id="optionsRadios2" value="own">不公开</label></span></div></div><div class="form-group" style="margin-bottom: 10px; padding-top: 10px;"><div class="col-sm-offset-3 col-sm-9"><a href="javascript:;" class="btn btn-primary" id="AddNewBtn">'+$.i18n.prop("submit")+"</a></div></div></div>",onshown:function(){$("#AddValueDialog .form-control").keyup(function(e){$(this).parents(".form-group").removeClass("has-error"),$(this).parents(".form-group").find(".errorText").remove()}),$("#AddNewBtn").off("click").on("click",function(){var t=$(this);if(!$(this).hasClass("disable")){var a=!0;$("#AddValueDialog .form-control").each(function(){""==$(this).val()&&($(this).parent().find(".errorText").remove(),$(this).parent().append('<div class="errorText">不能为空！</div>'),$(this).parents(".form-group").addClass("has-error"))}),a&&($(this).addClass("disable"),Util.ajax({url:"ConnectController/saveConnection",data:{connectName:$("#AddValueDialog .connName").val(),connectType:$("#AddValueDialog .connType").val(),connectUrl:$("#AddValueDialog .connUrl").val(),connectUser:$("#AddValueDialog .connUser").val(),connectPwd:$("#AddValueDialog .connPasswd").val(),connectOwner:$("input[name='optionsRadios']:checked").val()},success:function(a){1==a.code?(swal("Successful!","","success"),e.close(),getConnectList()):(swal("Error",a.data,"error"),t.removeClass("disable"))}}))}})}})})}function init(){setCookieData(),getConnectList(),getAppList(),getQueryList(),getStatusInfo(),setInterval(function(){getStatusInfo()},6e4),bindEvent()}var _pathName=window.location.pathname;_pathName=_pathName.substring(1,_pathName.lastIndexOf("/")),window.UserName=$("#UserName").html()+"_"+_pathName+"_";var ConnId,ChromeTab,AppList={},TimerResult,ErrorTip={},QueryKey={},LogKey={},QueryCountKey={},ErrorStatus={},ErrorStatusDownload={},SuccessLogStatus={},SuccessResultStatus={},QueryUser={},QueryAppName={},QueryDownloadKey={},QueryDownloadFile={},QueryHistory={},QueryStop={},DownloadFile=[],Downloading={},SqlParam={},TimerResultTab,RunningTab;window.getPartitions=function(e){var t="";return $.ajax({url:"entry/getPartitionsByTblName",data:{dbName:$("#DatabaseChosen .fixedVal").val(),tblName:e},async:!1,success:function(e){e=e.data;var a=[];e.length>0&&($.each(e,function(e,t){a.push(t+"=''")}),t+="WHERE "+a.join(" AND "))}}),t},init()});